<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAGUAR COMMAND CENTER</title>
    <link rel="icon" href="https://i.postimg.cc/WbcLNVJ1/Gemini-Generated-Image-8lzcv38lzcv38lzc.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .neon-green { color: #39FF14; text-shadow: 0 0 15px rgba(57, 255, 20, 0.6); }
        .neon-red { color: #FF073A; text-shadow: 0 0 15px rgba(255, 7, 58, 0.6); }
        
        .glass-panel { 
            background: linear-gradient(145deg, rgba(20,20,20,0.8) 0%, rgba(10,10,10,0.95) 100%); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            min-height: 160px;
        }
        
        /* Buttons */
        .btn-execute { background: rgba(57, 255, 20, 0.05); border: 2px solid #39FF14; color: #39FF14; transition: all 0.2s; box-shadow: 0 0 15px rgba(57,255,20,0.1); }
        .btn-execute:active { transform: scale(0.95); }
        
        .btn-execute.short { background: rgba(255, 7, 58, 0.05); border-color: #FF073A; color: #FF073A; box-shadow: 0 0 15px rgba(255, 7, 58, 0.1); }
        
        .btn-execute.limit { background: rgba(255, 255, 255, 0.05); border-color: #aaa; color: #aaa; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); }
        .btn-execute.limit:hover { border-color: #fff; color: #fff; }

        .btn-execute.armed { background: rgba(255, 165, 0, 0.1); border-color: #FFA500; color: #FFA500; animation: pulse-orange 2s infinite; }
        
        .btn-execute.active-trade { background: rgba(255, 255, 255, 0.1); border-color: #fff; color: #fff; box-shadow: 0 0 20px rgba(255, 255, 255, 0.2); cursor: pointer; }
        .btn-execute.active-trade:hover { background: rgba(255, 0, 0, 0.2); border-color: #FF073A; color: #FF073A; }

        /* Mode Switcher */
        .mode-switch { display: flex; background: rgba(0,0,0,0.5); border-radius: 0.5rem; padding: 2px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn { flex: 1; padding: 4px; text-align: center; font-size: 0.7rem; font-family: 'JetBrains Mono'; color: #666; cursor: pointer; border-radius: 0.3rem; transition: all 0.2s; }
        .mode-btn.active { background: #333; color: #fff; font-weight: bold; }

        .tf-container { -ms-overflow-style: none; scrollbar-width: none; }
        .tf-container::-webkit-scrollbar { display: none; }
        .tf-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #888; font-family: 'JetBrains Mono'; font-size: 0.7rem; transition: all 0.2s; white-space: nowrap; min-width: 35px; }
        .tf-btn:hover { border-color: #39FF14; color: #fff; }
        .tf-btn.active { background: #39FF14; color: #000; border-color: #39FF14; font-weight: bold; }
        
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 165, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); } }
        @keyframes slow-glow { 0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.2), inset 0 0 5px rgba(212, 175, 55, 0.1); border-color: rgba(212, 175, 55, 0.3); color: #888; } 50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.5), inset 0 0 10px rgba(212, 175, 55, 0.2); border-color: rgba(212, 175, 55, 1); color: #D4AF37; } }
        .help-glow { animation: slow-glow 4s ease-in-out infinite; }
        .jaguar-img-blend { mix-blend-mode: screen; }

        @media (max-width: 1024px) { .desktop-grid { display: flex; flex-direction: column; gap: 1rem; } .mobile-chart { height: 450px; order: -1; min-height: 450px; } .glass-panel { min-height: auto; } }
    </style>
</head>
<body class="min-h-screen w-full flex flex-col p-4 lg:p-6 overflow-y-auto lg:overflow-hidden relative">

    <header class="flex flex-col lg:flex-row justify-between items-center mb-6 shrink-0 gap-4 lg:gap-0">
        <div class="flex items-center gap-3 self-start lg:self-auto">
            <img src="https://i.postimg.cc/WbcLNVJ1/Gemini-Generated-Image-8lzcv38lzcv38lzc.png" alt="Jaguar Logo" class="w-14 h-14 object-contain jaguar-img-blend">
            <div><h1 class="text-2xl font-black tracking-[0.1em] text-white">JAGUAR <span class="text-[#D4AF37]">3Â·6Â·9</span></h1><div class="text-xs text-gray-500 tracking-widest">COMMAND CENTER</div></div>
            <button onclick="toggleModal(true)" class="ml-4 w-10 h-10 rounded-full border flex items-center justify-center transition-all help-glow">?</button>
        </div>
        <div class="flex gap-2 overflow-x-auto tf-container w-full lg:w-auto pb-1 lg:pb-0">
            <button class="tf-btn px-3 py-1 rounded active" onclick="changeTf('1m')" id="btn-1m">1m</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('5m')" id="btn-5m">5m</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('15m')" id="btn-15m">15m</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('30m')" id="btn-30m">30m</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('1h')" id="btn-1h">1H</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('4h')" id="btn-4h">4H</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('1d')" id="btn-1d">D</button>
            <button class="tf-btn px-3 py-1 rounded" onclick="changeTf('1w')" id="btn-1w">W</button>
        </div>
    </header>

    <div class="desktop-grid lg:grid lg:grid-cols-12 lg:grid-rows-6 gap-6 flex-1 lg:min-h-[600px]">
        <div class="lg:col-span-3 lg:row-span-6 flex flex-col gap-6">
            <div class="grid grid-cols-2 gap-4 flex-1">
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center items-center"><div class="text-[10px] text-gray-500 mb-1">LOCAL</div><div class="font-mono text-xl" id="clock-local">--:--</div></div>
                <div class="glass-panel rounded-2xl p-4 flex flex-col justify-center items-center"><div class="text-[10px] text-gray-500 mb-1">NY</div><div class="font-mono text-xl text-[#39FF14]" id="clock-ny">--:--</div></div>
            </div>
            <div class="glass-panel rounded-2xl p-6 flex flex-col justify-center items-center flex-[2]">
                <div class="text-[10px] text-gray-500 tracking-widest mb-4">MAJOR TREND</div><div class="text-4xl font-black mb-2" id="trend-text">WAITING</div><div class="text-6xl animate-pulse" id="trend-icon">--</div>
            </div>
            <div class="glass-panel rounded-2xl p-5 flex flex-col justify-center flex-1">
                <div class="flex justify-between mb-2 items-end"><span class="text-[10px] text-gray-500 uppercase">MFI Fuel</span><span class="text-xl font-mono" id="mfi-text-color"><span id="mfi-value">0</span>%</span></div>
                <div class="w-full bg-gray-900 rounded-sm h-4 overflow-hidden border border-gray-800 relative"><div class="bg-[#D4AF37] h-full transition-all duration-1000" style="width: 0%" id="mfi-bar"></div></div><div class="text-[9px] text-gray-600 mt-2 text-right">OVERBOUGHT > 80%</div>
            </div>
        </div>
        <div class="lg:col-span-6 lg:row-span-6 glass-panel rounded-2xl p-1 relative flex flex-col mobile-chart">
            <div class="absolute top-4 left-4 z-10 flex gap-3 flex-wrap">
                <div class="bg-black/60 backdrop-blur px-3 py-2 rounded border border-white/10 flex items-center gap-3">
                    <div class="w-8 h-8 bg-[#F7931A] rounded-full flex items-center justify-center text-black font-bold text-xs">â‚¿</div><div><div class="font-bold text-white text-xs">Bitcoin</div><div class="font-mono text-lg text-white" id="price-display">$00,000.00</div></div>
                </div>
                <div class="bg-black/60 backdrop-blur px-3 py-2 rounded border border-white/10 flex items-center gap-2 font-mono text-xs">
                     <span class="text-gray-400">TF:</span><span class="text-[#39FF14]" id="chart-tf-display">1m</span><span class="text-gray-600">|</span><span class="text-gray-400">CLOSE IN:</span><span class="text-white font-bold" id="candle-countdown">--:--</span>
                     <span class="text-gray-600">|</span><button onclick="fitChart()" class="text-[#D4AF37] hover:text-white transition-colors font-bold tracking-wider px-2 border border-[#D4AF37] rounded" title="Auto Scale Chart">AUTO</button>
                </div>
            </div>
            <div id="tv-chart" class="w-full h-full rounded-xl overflow-hidden"></div>
        </div>
        <div class="lg:col-span-3 lg:row-span-6 flex flex-col gap-6">
            <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center flex-[2] relative overflow-hidden">
                <div class="text-[10px] text-gray-500 mb-4 tracking-widest">JAGUAR SCORE</div><div class="text-8xl font-mono font-bold neon-green" id="score-display">0.0</div><div class="text-gray-600 text-xs mt-2 text-center">CONFIDENCE<br>LEVEL / 10</div>
            </div>
            
            <div class="glass-panel rounded-2xl p-6 flex flex-col flex-1">
                <div class="mode-switch">
                    <div class="mode-btn active" onclick="setMode('MARKET')" id="mode-market">MARKET</div>
                    <div class="mode-btn" onclick="setMode('LIMIT')" id="mode-limit">LIMIT (TRAP)</div>
                </div>
                
                <button id="main-btn" class="w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute wait group transition-all" onclick="handleBtnClick()">
                    <div class="text-2xl font-bold tracking-wider group-hover:scale-105 transition-transform" id="btn-text">WAITING...</div>
                    <div class="text-xs mt-2 opacity-70 font-mono" id="btn-subtext">(ANALYZING MARKET)</div>
                </button>
            </div>
        </div>
    </div>

    <div id="guide-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 opacity-0 pointer-events-none backdrop-blur-md p-4 transition-all duration-500">
        <div class="glass-panel max-w-5xl w-full max-h-[90vh] overflow-y-auto rounded-3xl p-8 relative border-[#D4AF37]/30">
            <button onclick="toggleModal(false)" class="absolute top-6 right-6 text-gray-500 hover:text-white text-xl">âœ•</button>
            <div class="text-center mb-8"><h2 class="text-4xl font-black text-[#D4AF37] tracking-widest mb-2">THE JAGUAR PROTOCOL</h2><p class="text-gray-400 font-mono">SYSTEM ARCHITECTURE v6.0 // SNIPER TRAP</p></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="guide-card"><div class="guide-icon text-[#39FF14]">ðŸŒŠ</div><h4 class="font-bold text-white">TREND (EMA 200)</h4><p class="text-xs text-gray-400 mt-2">"The River". Price above = LONG only. Price below = SHORT only.</p></div>
                <div class="guide-card"><div class="guide-icon text-[#D4AF37]">â›½</div><h4 class="font-bold text-white">FUEL (MFI 14)</h4><p class="text-xs text-gray-400 mt-2">"Gas Tank". Buy when empty (<20%). Sell when full (>80%).</p></div>
                <div class="guide-card"><div class="guide-icon text-[#39FF14]">ðŸ§ </div><h4 class="font-bold text-white">SCORE (0-10)</h4><p class="text-xs text-gray-400 mt-2"> > 7.5 = LONG. < 2.5 = SHORT.</p></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="guide-card border-[#00FFFF]/30"><div class="guide-icon text-[#00FFFF]">ðŸ’§</div><h4 class="font-bold text-[#00FFFF]">LIQUIDITY (Cyan)</h4><p class="text-xs text-gray-400 mt-2">"Shark Tanks". Price hunts these levels. Place LIMIT ORDERS here.</p></div>
                <div class="guide-card border-[#FFA500]/30"><div class="guide-icon text-[#FFA500]">ðŸ§²</div><h4 class="font-bold text-[#FFA500]">POC (Orange)</h4><p class="text-xs text-gray-400 mt-2">"Magnet". Fair Value price. Price tends to return here.</p></div>
            </div>
            <div class="bg-[#39FF14]/5 border border-[#39FF14]/20 p-4 rounded-xl text-center"><p class="text-gray-300 text-sm font-mono">NEW: USE 'LIMIT' MODE TO PLAN TRADES BEFORE EXECUTING.</p></div>
        </div>
    </div>

    <script>
        function toggleModal(show) { const m = document.getElementById('guide-modal'); show ? m.classList.remove('pointer-events-none', 'opacity-0') : m.classList.add('pointer-events-none', 'opacity-0'); }
        const chartContainer = document.getElementById('tv-chart');
        const chart = LightweightCharts.createChart(chartContainer, { layout: { background: { color: '#000000' }, textColor: '#666', }, grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } }, rightPriceScale: { borderColor: '#333', scaleMargins: { top: 0.2, bottom: 0.2 }, autoScale: true }, timeScale: { borderColor: '#333', timeVisible: true, secondsVisible: false }, });
        const candleSeries = chart.addCandlestickSeries({ upColor: '#39FF14', downColor: '#FF073A', borderVisible: false, wickUpColor: '#39FF14', wickDownColor: '#FF073A' });
        const metaLine = candleSeries.createPriceLine({ price: 0, color: '#39FF14', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dotted, axisLabelVisible: true, title: 'META 1 (TARGET)' });
        
        function fitChart() { chart.priceScale('right').applyOptions({ autoScale: true }); chart.timeScale().fitContent(); }

        let entryLine = null, slLine = null, tpLine = null, activeTrade = false, candleHistory = [];
        let liqHighLine = null, liqLowLine = null, pocLine = null;
        let tradeEntry = 0, tradeSL = 0, tradeTP = 0, tradeDir = null;
        
        // LIMIT ORDER VARS
        let executionMode = 'MARKET'; // 'MARKET' or 'LIMIT'
        let pendingOrder = null; // { price, sl, tp, dir }

        new ResizeObserver(entries => { if (entries.length === 0 || entries[0].target !== chartContainer) return; chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height }); chart.timeScale().fitContent(); }).observe(chartContainer);

        let ws, nextCloseTime = 0, countdownInterval, currentPrice = 0, firstLoad = true, marketSignal = null;

        function startCountdown() {
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                if (!nextCloseTime) return;
                const now = Math.floor(Date.now() / 1000); const diff = nextCloseTime - now;
                if (diff <= 0) { document.getElementById('candle-countdown').innerText = "CLOSING..."; return; }
                const h = Math.floor(diff / 3600); const m = Math.floor((diff % 3600) / 60); const s = diff % 60;
                let display = `${m}:${s < 10 ? '0' + s : s}`; if(h > 0) display = `${h}:${display}`;
                document.getElementById('candle-countdown').innerText = display;
            }, 1000);
        }

        function connect() {
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            ws = new WebSocket(protocol + window.location.host + "/ws");
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                currentPrice = data.price;
                document.getElementById('price-display').innerText = "$" + data.price.toLocaleString(undefined, {minimumFractionDigits: 2});
                
                // DATA UPDATE
                const scoreEl = document.getElementById('score-display'); scoreEl.innerText = data.score;
                scoreEl.className = data.score < 5 ? "text-8xl font-mono font-bold neon-red" : "text-8xl font-mono font-bold neon-green";
                const trendText = document.getElementById('trend-text'); const trendIcon = document.getElementById('trend-icon');
                trendText.innerText = data.trend;
                if(data.trend === "BULLISH") { trendText.className = "text-4xl font-black mb-2 neon-green"; trendIcon.innerText = "â†‘"; trendIcon.className = "text-6xl neon-green animate-bounce"; } 
                else if(data.trend === "BEARISH") { trendText.className = "text-4xl font-black mb-2 neon-red"; trendIcon.innerText = "â†“"; trendIcon.className = "text-6xl neon-red animate-bounce"; }
                else { trendText.className = "text-4xl font-black mb-2 text-gray-500"; trendIcon.innerText = "--"; trendIcon.className = "text-6xl text-gray-500"; }
                document.getElementById('mfi-value').innerText = data.mfi; document.getElementById('mfi-bar').style.width = data.mfi + "%";
                document.getElementById('mfi-text-color').className = data.mfi > 80 ? "text-xl font-mono text-red-500" : (data.mfi < 20 ? "text-xl font-mono neon-green" : "text-xl font-mono text-[#D4AF37]");

                // SAVE SIGNAL FOR LIMIT LOGIC
                if(data.score >= 7.5) marketSignal = "LONG";
                else if(data.score <= 2.5) marketSignal = "SHORT";
                else marketSignal = null;

                updateButtonState();

                // PENDING ORDER MONITOR (The Trap)
                if(pendingOrder) {
                    if( (pendingOrder.dir === 'LONG' && currentPrice <= pendingOrder.price) || 
                        (pendingOrder.dir === 'SHORT' && currentPrice >= pendingOrder.price) ) {
                        // TRIGGER TRAP!
                        activateTrap();
                    }
                }

                // ACTIVE TRADE MONITOR
                if(activeTrade) {
                    if(tradeDir === 'LONG') {
                        if(currentPrice >= tradeTP) { alert(`ðŸ’° TARGET HIT!\nProfit: +$${(currentPrice - tradeEntry).toFixed(2)}`); closeTrade(); } 
                        else if (currentPrice <= tradeSL) { alert(`ðŸ’€ STOP HIT!\nLoss: -$${(tradeEntry - currentPrice).toFixed(2)}`); closeTrade(); }
                    } else if (tradeDir === 'SHORT') {
                         if(currentPrice <= tradeTP) { alert(`ðŸ’° TARGET HIT!\nProfit: +$${(tradeEntry - currentPrice).toFixed(2)}`); closeTrade(); } 
                        else if (currentPrice >= tradeSL) { alert(`ðŸ’€ STOP HIT!\nLoss: -$${(currentPrice - tradeEntry).toFixed(2)}`); closeTrade(); }
                    }
                }

                if (data.institutional) {
                    if (liqHighLine) candleSeries.removePriceLine(liqHighLine);
                    liqHighLine = candleSeries.createPriceLine({ price: data.institutional.liq_high, color: '#00FFFF', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'LIQUIDITY (HIGH)' });
                    if (liqLowLine) candleSeries.removePriceLine(liqLowLine);
                    liqLowLine = candleSeries.createPriceLine({ price: data.institutional.liq_low, color: '#00FFFF', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'LIQUIDITY (LOW)' });
                    if (pocLine) candleSeries.removePriceLine(pocLine);
                    pocLine = candleSeries.createPriceLine({ price: data.institutional.poc, color: '#FFA500', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'POC' });
                }

                if (data.candle) {
                    candleSeries.update(data.candle);
                    metaLine.applyOptions({ price: data.price * 1.01 });
                    if (data.next_close && data.next_close !== nextCloseTime) { nextCloseTime = data.next_close; startCountdown(); }
                    candleHistory.push(data.candle); if(candleHistory.length > 20) candleHistory.shift();
                    if(firstLoad) { fitChart(); firstLoad = false; }
                }
            };
            ws.onclose = () => setTimeout(connect, 3000);
        }

        function setMode(mode) {
            if(activeTrade || pendingOrder) return; // Lock if busy
            executionMode = mode;
            document.getElementById('mode-market').className = mode === 'MARKET' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('mode-limit').className = mode === 'LIMIT' ? 'mode-btn active' : 'mode-btn';
            updateButtonState();
        }

        function updateButtonState() {
            const btn = document.getElementById('main-btn');
            const btnText = document.getElementById('btn-text');
            const btnSub = document.getElementById('btn-subtext');

            if(activeTrade) {
                btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute active-trade";
                btnText.innerText = "CLOSE POSITION X"; btnSub.innerText = "AUTO-MONITORING...";
                return;
            }

            if(pendingOrder) {
                btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute armed";
                btnText.innerText = "TRAP ARMED"; btnSub.innerText = `WAITING FOR ${pendingOrder.price.toFixed(2)}... (CLICK TO CANCEL)`;
                return;
            }

            if(executionMode === 'LIMIT') {
                if(marketSignal) {
                    btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute limit";
                    btnText.innerText = "PLAN " + marketSignal + " ENTRY"; btnSub.innerText = "(CLICK TO SET TRAP PRICE)";
                } else {
                    btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute wait";
                    btnText.innerText = "WAITING FOR SIGNAL"; btnSub.innerText = "CANNOT PLAN WITHOUT SIGNAL";
                }
                return;
            }

            // MARKET MODE (Standard)
            if (marketSignal === "LONG") { 
                btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute"; 
                btnText.innerText = "EXECUTE LONG"; btnSub.innerText = "($100 RISK)"; 
            } else if (marketSignal === "SHORT") { 
                btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute short"; 
                btnText.innerText = "EXECUTE SHORT"; btnSub.innerText = "($100 RISK)"; 
            } else { 
                btn.className = "w-full h-full border rounded-xl flex flex-col items-center justify-center btn-execute wait"; 
                btnText.innerText = "WAITING FOR SIGNAL"; btnSub.innerText = "(SCORE MUST BE >7.5 or <2.5)"; 
            }
        }

        function handleBtnClick() {
            const btnText = document.getElementById('btn-text').innerText;
            
            if(activeTrade) { alert("POSITION CLOSED MANUALLY"); closeTrade(); return; }
            if(pendingOrder) { alert("TRAP DISARMED"); closeTrade(); return; } // Cancel pending
            if(btnText.includes("WAITING")) return;

            // MARKET EXECUTION
            if(executionMode === 'MARKET') {
                launchTrade(currentPrice, marketSignal);
            } 
            // LIMIT EXECUTION (Plan First)
            else if (executionMode === 'LIMIT') {
                let suggestedPrice = currentPrice;
                let userPrice = prompt("ENTER TRAP PRICE ($):", suggestedPrice);
                if(userPrice) {
                    userPrice = parseFloat(userPrice);
                    planLimitOrder(userPrice, marketSignal);
                }
            }
        }

        function planLimitOrder(price, dir) {
            // Draw Ghost Lines
            pendingOrder = { price: price, dir: dir };
            
            // Calculate hypothetical SL/TP based on chart structure
            let sl, tp;
            if(dir === 'LONG') {
                let lowest = price * 0.99;
                if(candleHistory.length > 5) { lowest = Math.min(...candleHistory.slice(-10).map(c => c.low)); if(lowest >= price) lowest = price * 0.995; }
                sl = lowest; tp = price + (2 * (price - sl));
                
                entryLine = candleSeries.createPriceLine({ price: price, color: '#888', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'TRAP ENTRY: ' + price });
                slLine = candleSeries.createPriceLine({ price: sl, color: '#FF073A', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'PENDING STOP' });
                tpLine = candleSeries.createPriceLine({ price: tp, color: '#39FF14', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'PENDING TARGET' });
            } else {
                let highest = price * 1.01;
                if(candleHistory.length > 5) { highest = Math.max(...candleHistory.slice(-10).map(c => c.high)); if(highest <= price) highest = price * 1.005; }
                sl = highest; tp = price - (2 * (sl - price));
                
                entryLine = candleSeries.createPriceLine({ price: price, color: '#888', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'TRAP ENTRY: ' + price });
                slLine = candleSeries.createPriceLine({ price: sl, color: '#FF073A', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'PENDING STOP' });
                tpLine = candleSeries.createPriceLine({ price: tp, color: '#39FF14', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: 'PENDING TARGET' });
            }
            
            // Store calculated SL/TP for when it activates
            pendingOrder.sl = sl;
            pendingOrder.tp = tp;
            
            // Wait for confirmation logic handled in updateButtonState()
            updateButtonState();
        }

        function activateTrap() {
            // Convert pending lines to solid
            candleSeries.removePriceLine(entryLine); candleSeries.removePriceLine(slLine); candleSeries.removePriceLine(tpLine);
            
            tradeEntry = pendingOrder.price; tradeSL = pendingOrder.sl; tradeTP = pendingOrder.tp; tradeDir = pendingOrder.dir;
            activeTrade = true; pendingOrder = null;

            entryLine = candleSeries.createPriceLine({ price: tradeEntry, color: '#3B82F6', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'ENTRY: ' + tradeEntry.toFixed(2) });
            slLine = candleSeries.createPriceLine({ price: tradeSL, color: '#FF073A', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'STOP: ' + tradeSL.toFixed(2) });
            tpLine = candleSeries.createPriceLine({ price: tradeTP, color: '#39FF14', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'TARGET: ' + tradeTP.toFixed(2) });
            
            alert("TRAP TRIGGERED! TRADE ACTIVE.");
            updateButtonState();
        }

        function launchTrade(price, dir) {
            tradeDir = dir; tradeEntry = price; activeTrade = true; pendingOrder = null;
            
            let sl, tp;
            if(dir === 'LONG') {
                let lowest = price * 0.99;
                if(candleHistory.length > 5) { lowest = Math.min(...candleHistory.slice(-10).map(c => c.low)); if(lowest >= price) lowest = price * 0.995; }
                sl = lowest; tp = price + (2 * (price - sl));
            } else {
                let highest = price * 1.01;
                if(candleHistory.length > 5) { highest = Math.max(...candleHistory.slice(-10).map(c => c.high)); if(highest <= price) highest = price * 1.005; }
                sl = highest; tp = price - (2 * (sl - price));
            }
            tradeSL = sl; tradeTP = tp;

            clearTradeLines();
            entryLine = candleSeries.createPriceLine({ price: tradeEntry, color: '#3B82F6', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'ENTRY: ' + tradeEntry.toFixed(2) });
            slLine = candleSeries.createPriceLine({ price: tradeSL, color: '#FF073A', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'STOP: ' + tradeSL.toFixed(2) });
            tpLine = candleSeries.createPriceLine({ price: tradeTP, color: '#39FF14', lineWidth: 2, lineStyle: LightweightCharts.LineStyle.Solid, axisLabelVisible: true, title: 'TARGET: ' + tradeTP.toFixed(2) });
            updateButtonState();
        }

        function changeTf(tf) {
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + tf).classList.add('active');
            document.getElementById('chart-tf-display').innerText = tf; document.getElementById('candle-countdown').innerText = "SYNCING..."; nextCloseTime = 0;
            candleHistory = []; closeTrade(); firstLoad = true;
            if(ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ timeframe: tf })); candleSeries.setData([]); }
        }

        function clearTradeLines() { if(entryLine) candleSeries.removePriceLine(entryLine); if(slLine) candleSeries.removePriceLine(slLine); if(tpLine) candleSeries.removePriceLine(tpLine); }
        function closeTrade() { activeTrade = false; pendingOrder = null; tradeDir = null; clearTradeLines(); updateButtonState(); }

        setInterval(() => { const now = new Date(); document.getElementById('clock-local').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); document.getElementById('clock-ny').innerText = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"})).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        connect();
    </script>
</body>
</html>
